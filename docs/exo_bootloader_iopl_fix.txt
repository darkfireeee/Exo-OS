; kernel/src/arch/x86_64/boot/boot_iopl_fix.asm
;
; FIX IOPL POUR AUTORISER LES INSTRUCTIONS I/O

section .text
bits 64

; Point d'entrée depuis boot.asm AVANT d'appeler boot_main
global fix_iopl
fix_iopl:
    ; Sauvegarder les registres
    push rax
    push rbx
    
    ; Lire RFLAGS
    pushfq
    pop rax
    
    ; Vérifier IOPL actuel
    mov rbx, rax
    shr rbx, 12
    and rbx, 3
    
    ; Si IOPL != 3, le fixer
    cmp rbx, 3
    je .iopl_ok
    
    ; Set IOPL=3 (bits 12-13 de RFLAGS)
    or rax, 0x3000
    
    ; Écrire RFLAGS
    push rax
    popfq
    
.iopl_ok:
    ; Restaurer les registres
    pop rbx
    pop rax
    ret


; Alternative: Set IOPL=3 directement au début du boot
; À ajouter dans boot.asm après le passage en long mode:

global set_iopl_early
set_iopl_early:
    pushfq              ; Push RFLAGS
    pop rax             ; Pop dans RAX
    or rax, 0x3000      ; Set bits 12-13 (IOPL=3)
    push rax            ; Push modifié
    popfq               ; Pop dans RFLAGS
    ret


; Version inline à ajouter dans boot.asm:
; 
; long_mode_start:
;     ; ... setup des segments ...
;     
;     ; FIX IOPL AVANT TOUT
;     pushfq
;     pop rax
;     or rax, 0x3000      ; IOPL=3
;     push rax
;     popfq
;     
;     ; ... continuer le boot ...
;     call boot_main
